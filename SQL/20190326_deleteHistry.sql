ALTER TABLE `mahamevnainfo`.`changelistbhikku` 
ADD COLUMN `ChangeType` INT NULL DEFAULT NULL AFTER `Post`;

UPDATE `mahamevnainfo`.`changelistbhikku` 
SET `ChangeType` = 0
WHERE Id > 0;


USE `mahamevnainfo`;
DROP procedure IF EXISTS `ChangeListBhikku_Add`;

DELIMITER $$
USE `mahamevnainfo`$$
CREATE DEFINER=`root`@`localhost` PROCEDURE `ChangeListBhikku_Add`(p_ChangeListID INT,p_BhikkuID INT,
                                        p_AsapuwaID INT,OUT p_ID int,p_Post INT,p_ChangeType INT)
BEGIN

    INSERT INTO changelistbhikku(ChangeListID,BhikkuID,AsapuwaID,Post,ChangeType)
    VALUES(p_ChangeListID,p_BhikkuID,p_AsapuwaID,p_Post,p_ChangeType);
    
    SET p_ID = LAST_INSERT_ID();
    
END$$

DELIMITER ;


USE `mahamevnainfo`;
DROP procedure IF EXISTS `ChangeListBhikku_Upd`;

DELIMITER $$
USE `mahamevnainfo`$$
CREATE DEFINER=`root`@`localhost` PROCEDURE `ChangeListBhikku_Upd`(p_ID INT,p_Post INT, p_ChangeType INT)
BEGIN

    UPDATE changelistbhikku 
    SET Post = p_Post,
	ChangeType = p_ChangeType	
    WHERE ID = p_ID;

END$$

USE `mahamevnainfo`;
DROP procedure IF EXISTS `ChangeListBhikku_Sel`;

DELIMITER $$
USE `mahamevnainfo`$$
CREATE DEFINER=`root`@`localhost` PROCEDURE `ChangeListBhikku_Sel`(p_ChangeListID INT)
BEGIN

    SELECT ID,BhikkuID,AsapuwaID,Post,ChangeType
    FROM changelistbhikku
    WHERE ChangeListID = p_ChangeListID AND BhikkuID > 0;

END$$

DELIMITER ;


ALTER TABLE `mahamevnainfo`.`bikkuinfo` 
ADD COLUMN `isResignFromStudent` BIT NULL AFTER `HomeTP2`;

USE `mahamevnainfo`;
DROP procedure IF EXISTS `Bikku_Sel`;

DELIMITER $$
USE `mahamevnainfo`$$
CREATE DEFINER=`root`@`localhost` PROCEDURE `Bikku_Sel`(p_ID int)
BEGIN

    SELECT  NIC,SamaneraNumber,PassportNumber,PlaceOfBirth,LayNameInFull,DateOfBirth,NameOfFatherInFull,DateOfRobing,NameAssumedAtRobing,NameOfRobingTutor,TempleRobing,
        TempleOfResidence,NameOfViharadhipathi,IsUpasampanna,PlaceOfHigherOrdination,DateOfHigherOrdination,NameOfUpadyaAtHigherOrdination,IsUpadyaThero,
        Post,District,DateOfCame,ImageData,BloodGroup,Dharmadeshanaa ,Vandanaa ,Sajjayana ,Sinhala ,Tamil ,English ,Hindhi ,
        OtheLanguage ,UpasampadaNumber ,UpasampadaRegDate ,KarmacharyaHimi1 ,
        KarmacharyaHimi2 ,KarmacharyaHimi3 ,MahaNayakaHimidetails ,AcharyaHimiDetails ,
        UpadyaTheroName ,Nikaya,HomeTP,HomeAddress,UpasampadaMahaNayakaHimidetails,UpasampadaAcharyaHimiDetails,UpasampadaNikaya,
        country,CASE currentStatus WHEN 1 THEN (SELECT COUNT(b.ID) FROM BikkuInfo b WHERE b.ID <= p_ID  AND b.Deleted = 0 AND b.CurrentStatus = 1) ELSE 0 END,number,currentStatus,currentStatusComment,
        HomeTP2, isResignFromStudent
       
        
    FROM BikkuInfo
    WHERE ID = p_ID;

END$$

DELIMITER ;

USE `mahamevnainfo`;
DROP procedure IF EXISTS `Bikku_Add`;

DELIMITER $$
USE `mahamevnainfo`$$
CREATE DEFINER=`root`@`localhost` PROCEDURE `Bikku_Add`(P_NIC varchar(10),p_SamaneraNumber varchar(10),p_PassportNumber varchar(20),p_PlaceOfBirth varchar(100),
                        p_LayNameInFull varchar(100),p_DateOfBirth Date,p_NameOfFatherInFull varchar(100),p_DateOfRobing Date,
                        p_NameAssumedAtRobing varchar(100),p_NameOfRobingTutor int,p_TempleRobing int,
                        p_TempleOfResidence int,p_NameOfViharadhipathi int,p_IsUpasampanna bit,
                        p_PlaceOfHigherOrdination int,p_DateOfHigherOrdination Date,
                        p_NameOfUpadyaAtHigherOrdination int,p_IsUpadyaThero bit,
                        p_Post int,p_District int,p_DateOfCame Date,p_ImageData LONGTEXT,
                        p_HomeTP varchar(15),p_BloodGroup varchar(3),OUT p_ID int, p_HomeAddress varchar(200),
                        
                        p_Dharmadeshanaa bit,p_Vandanaa bit,p_Sajjayana bit,p_Sinhala bit,p_Tamil bit,p_English bit,p_Hindhi bit,
                        p_OtheLanguage VARCHAR(100),p_UpasampadaNumber VARCHAR(45),p_UpasampadaRegDate DATE,p_KarmacharyaHimi1 INT,
                        p_KarmacharyaHimi2 INT,p_KarmacharyaHimi3 INT,p_MahaNayakaHimidetails INT,p_AcharyaHimiDetails INT,
                        p_UpadyaTheroName INT,p_Nikaya INT,P_UpasampadaMahaNayakaHimidetails INT,p_UpasampadaAcharyaHimiDetails INT,
                        p_UpasampadaNikaya INT,p_country INT,p_number INT,p_currentStatus INT,p_currentStatusComment VARCHAR(1000)
                        ,p_duplicateNumber bit,p_HomeTP2 VARCHAR(15),p_ResignStudent bit)
BEGIN


IF p_duplicateNumber = true 
THEN
    
    ALTER TABLE `mahamevnainfo`.`bikkuinfo` 
    DROP INDEX `number_UNIQUE` ;
    
    UPDATE  BikkuInfo  SET number = number+1 WHERE number >= p_number ;
    
    
      ALTER TABLE `mahamevnainfo`.`bikkuinfo`
    ADD UNIQUE INDEX `number_UNIQUE` (`number` ASC) ;
    
END IF;


    INSERT INTO BikkuInfo
        (NIC,SamaneraNumber,PassportNumber,PlaceOfBirth,LayNameInFull,
        DateOfBirth,NameOfFatherInFull,DateOfRobing,NameAssumedAtRobing,
        NameOfRobingTutor,TempleRobing,TempleOfResidence,NameOfViharadhipathi,
        IsUpasampanna,PlaceOfHigherOrdination,DateOfHigherOrdination,
        NameOfUpadyaAtHigherOrdination,IsUpadyaThero,Post,
        District,DateOfCame,ImageData,Deleted,HomeTP,BloodGroup,HomeAddress,
        Dharmadeshanaa ,Vandanaa ,Sajjayana ,Sinhala ,Tamil ,English ,Hindhi ,
        OtheLanguage ,UpasampadaNumber ,UpasampadaRegDate ,KarmacharyaHimi1 ,
        KarmacharyaHimi2 ,KarmacharyaHimi3 ,MahaNayakaHimidetails ,AcharyaHimiDetails ,
        UpadyaTheroName ,Nikaya,UpasampadaMahaNayakaHimidetails,UpasampadaAcharyaHimiDetails,
        UpasampadaNikaya,country,number,currentStatus,currentStatusComment,HomeTP2,isResignFromStudent)
        
    VALUES(P_NIC,p_SamaneraNumber,p_PassportNumber,p_PlaceOfBirth,
    p_LayNameInFull,p_DateOfBirth,p_NameOfFatherInFull,p_DateOfRobing,
    p_NameAssumedAtRobing,p_NameOfRobingTutor,p_TempleRobing,
    p_TempleOfResidence,p_NameOfViharadhipathi,p_IsUpasampanna,
    p_PlaceOfHigherOrdination,p_DateOfHigherOrdination,
    p_NameOfUpadyaAtHigherOrdination,p_IsUpadyaThero,
    p_Post,p_District,p_DateOfCame,p_ImageData,0,p_HomeTP,p_BloodGroup,p_HomeAddress,
    p_Dharmadeshanaa ,p_Vandanaa ,p_Sajjayana ,p_Sinhala ,p_Tamil ,p_English ,p_Hindhi ,
    p_OtheLanguage ,p_UpasampadaNumber ,p_UpasampadaRegDate ,p_KarmacharyaHimi1 ,
    p_KarmacharyaHimi2 ,p_KarmacharyaHimi3 ,p_MahaNayakaHimidetails ,p_AcharyaHimiDetails ,
    p_UpadyaTheroName ,p_Nikaya ,P_UpasampadaMahaNayakaHimidetails,p_UpasampadaAcharyaHimiDetails,
    p_UpasampadaNikaya,p_country,p_number,p_currentStatus,p_currentStatusComment,p_HomeTP2,p_ResignStudent
    
    );

    SET p_ID = LAST_INSERT_ID();

END$$

DELIMITER ;


USE `mahamevnainfo`;
DROP procedure IF EXISTS `Bikku_Upd`;

DELIMITER $$
USE `mahamevnainfo`$$
CREATE DEFINER=`root`@`localhost` PROCEDURE `Bikku_Upd`(P_NIC varchar(10),p_SamaneraNumber varchar(10),p_PassportNumber varchar(20),p_PlaceOfBirth varchar(100),
                        p_LayNameInFull varchar(100),p_DateOfBirth Date,p_NameOfFatherInFull varchar(100),p_DateOfRobing Date,
                        p_NameAssumedAtRobing varchar(100),p_NameOfRobingTutor int,p_TempleRobing int,
                        p_TempleOfResidence int,p_NameOfViharadhipathi int,p_IsUpasampanna bit,
                        p_PlaceOfHigherOrdination int,p_DateOfHigherOrdination Date,
                        p_NameOfUpadyaAtHigherOrdination int,p_IsUpadyaThero bit,
                        p_Post bit,p_District int,p_DateOfCame Date,p_ImageData LONGTEXT,
                        p_HomeTP varchar(15),p_BloodGroup varchar(3),p_ID int, p_HomeAddress varchar(200),
                        
                        p_Dharmadeshanaa bit,p_Vandanaa bit,p_Sajjayana bit,p_Sinhala bit,p_Tamil bit,p_English bit,p_Hindhi bit,
                        p_OtheLanguage VARCHAR(100),p_UpasampadaNumber VARCHAR(45),p_UpasampadaRegDate DATE,p_KarmacharyaHimi1 INT,
                        p_KarmacharyaHimi2 INT,p_KarmacharyaHimi3 INT,p_MahaNayakaHimidetails INT,p_AcharyaHimiDetails INT,
                        p_UpadyaTheroName INT,p_Nikaya INT,P_UpasampadaMahaNayakaHimidetails INT,p_UpasampadaAcharyaHimiDetails INT,
                        p_UpasampadaNikaya INT,p_country INT,p_number INT,p_currentStatus INT,p_currentStatusComment VARCHAR(1000)
                        ,p_duplicateNumber bit,p_HomeTP2 VARCHAR(15),p_ResignStudent bit)
BEGIN


IF p_duplicateNumber = true 
THEN
    
    ALTER TABLE `mahamevnainfo`.`bikkuinfo` 
    DROP INDEX `number_UNIQUE` ;
    
    UPDATE  BikkuInfo  SET number = number+1 WHERE number >= p_number ;
    
    
    ALTER TABLE `mahamevnainfo`.`bikkuinfo`
    ADD UNIQUE INDEX `number_UNIQUE` (`number` ASC) ;
    
END IF;


    UPDATE BikkuInfo 
    SET NIC = p_NIC ,SamaneraNumber = p_SamaneraNumber,
        PassportNumber = p_PassportNumber,
        PlaceOfBirth = p_PlaceOfBirth,
        LayNameInFull=p_LayNameInFull,DateOfBirth=p_DateOfBirth,
        NameOfFatherInFull=p_NameOfFatherInFull,DateOfRobing=p_DateOfRobing,
        NameAssumedAtRobing=p_NameAssumedAtRobing,
        NameOfRobingTutor=p_NameOfRobingTutor,TempleRobing=p_TempleRobing,
        TempleOfResidence=p_TempleOfResidence,
        NameOfViharadhipathi=p_NameOfViharadhipathi,
        IsUpasampanna=p_IsUpasampanna,
        PlaceOfHigherOrdination=p_PlaceOfHigherOrdination,
        DateOfHigherOrdination=p_DateOfHigherOrdination,
        NameOfUpadyaAtHigherOrdination=p_NameOfUpadyaAtHigherOrdination,
        IsUpadyaThero = p_IsUpadyaThero,        
        District = p_District, DateOfCame = p_DateOfCame, 
        ImageData = p_ImageData ,HomeTP = p_HomeTP,BloodGroup = p_BloodGroup,
        HomeAddress = p_HomeAddress,Dharmadeshanaa = p_Dharmadeshanaa,Vandanaa = p_Vandanaa,
        Sajjayana = p_Sajjayana,Sinhala = p_Sinhala,Tamil = p_Tamil,English = p_English,Hindhi = p_Hindhi,
        OtheLanguage = p_OtheLanguage,UpasampadaNumber = p_UpasampadaNumber,UpasampadaRegDate = p_UpasampadaRegDate,
        KarmacharyaHimi1 = p_KarmacharyaHimi1,KarmacharyaHimi2 = p_KarmacharyaHimi2,KarmacharyaHimi3 = p_KarmacharyaHimi3,
        MahaNayakaHimidetails = p_MahaNayakaHimidetails,AcharyaHimiDetails = p_AcharyaHimiDetails,
        UpadyaTheroName = p_UpadyaTheroName,Nikaya = p_Nikaya,
        
        UpasampadaMahaNayakaHimidetails = P_UpasampadaMahaNayakaHimidetails,UpasampadaAcharyaHimiDetails = p_UpasampadaAcharyaHimiDetails,
        UpasampadaNikaya = p_UpasampadaNikaya, country = p_country,number = p_number,
        currentStatus = p_currentStatus,currentStatusComment = p_currentStatusComment,
        HomeTP2 = p_HomeTP2,
        isResignFromStudent = p_ResignStudent
       
        
    WHERE ID = p_ID;



END$$

DELIMITER ;


UPDATE `mahamevnainfo`.`BikkuInfo` 
SET `isResignFromStudent` = 0
WHERE Id > 0;


-- SELECT * FROM mahamevnainfo.changelistbhikku where changelistid = 25 and asapuwaid = 10 order by bhikkuId ;
********
-- add unique key
********
delete from changelistbhikku 
where id not in (13328,
13330,
13329,
13331,
13310,
13311,
13981,
13312,
13318,
13315,
13316,
13544,
13320,
13321,
13515,
13325,
13323,
13326,
13526,
13516,
14506,
13332,
14521,
13324,
12546,
13297,
12690,
13572,
12600,
13334,
13296,
13124,
13126,
13149,
12732,
13522,
12759,
12788,
12994,
12733,
12904,
13463,
12552,
13716,
12570,
13063,
12954,
13292,
12829,
12731,
12730,
13119,
12724,
14541,
13519,
12782,
12789,
12589,
13390,
13589,
13017,
13590,
13389,
13249,
13469,
13391,
12740,
13097,
12963,
13252,
13251,
13028,
13555,
13438,
13246,
12555,
13722,
12680,
12626,
13479,
12688,
13591,
12652,
12992,
13610,
13611,
12927,
13460,
12672,
13550,
12693,
13099,
12691,
12692,
14307,
12932,
12696,
12697,
12700,
13539,
13386,
12908,
13592,
13432,
12936,
13533,
13559,
13036,
13452,
12627,
12584,
13396,
12800,
13377,
12816,
13417,
12849,
13565,
13598,
12553,
13476,
13307,
12628,
12845,
12846,
13184,
12735,
12734,
12918,
12978,
13445,
13030,
13439,
13547,
13433,
13136,
13376,
12681,
12669,
12784,
12808,
13510,
12658,
12678,
13137,
12572,
12606,
13294,
12938,
12948,
12950,
13474,
12939,
12952,
12941,
13470,
12942,
12945,
12943,
13107,
12922,
13507,
12909,
12944,
12541,
13240,
12651,
12998,
13583,
13066,
13076,
13456,
12583,
13305,
12793,
12806,
12807,
13403,
12811,
12830,
13131,
12632,
12767,
12772,
12999,
13532,
13581,
13449,
13448,
13044,
12625,
12791,
12825,
12738,
12865,
12864,
13247,
12558,
12766,
12968,
12804,
13037,
13112,
13109,
12560,
12988,
12989,
12987,
13606,
12551,
13140,
13461,
13395,
13424,
13128,
13459,
12590,
13242,
13154,
13513,
12568,
13400,
13401,
13412,
12752,
12598,
13339,
12841,
12868,
12877,
13260,
12706,
12715,
12671,
13397,
13423,
13385,
12708,
12705,
12709,
12518,
12451,
13348,
13419,
12556,
13138,
12454,
12539,
13139,
13764,
13341,
13560,
12459,
12458,
12457,
13509,
12538,
13333,
12462,
13426,
12522,
12521,
13241,
12461,
13651,
12464,
13368,
12493,
12465,
13367,
13959,
12466,
12494,
13974,
12467,
13055,
12979,
12780,
12468,
12496,
12470,
12810,
12497,
12815,
12471,
12472,
12473,
12523,
12474,
12476,
12475,
13543,
13006,
12478,
12519,
12481,
14274,
12482,
12483,
12484,
12485,
12526,
12533,
13375,
12862,
12486,
12867,
13093,
13111,
12530,
12502,
13061,
12883,
13399,
12893,
13340,
13580,
12899,
12900,
12531,
13054,
12488,
12516,
13129,
12489,
13346,
12509,
12916,
12491,
12511,
12510,
13284,
13443,
13481,
13482,
13483,
13484,
13485,
13486,
13487,
13488,
14664,
13489,
13490,
13491,
13492,
13493,
13494,
13495,
13496,
13497,
13498,
13499,
13500,
13501,
13502,
13503,
14679,
13504,
13505,
13573,
13064,
12762,
13465,
12821,
12596,
13379,
12847,
13413,
13256,
12957,
13837,
13406,
13588,
13454,
12597,
12851,
12858,
13574,
13048,
13594,
12566,
12925,
12956,
12760,
12763,
12981,
12982,
12785,
12796,
12798,
12801,
13427,
12818,
13108,
13019,
12842,
12844,
13508,
13343,
12852,
13106,
13566,
13446,
12934,
13062,
13336,
13545,
12819,
13415,
12695,
12884,
13408,
12722,
12579,
12764,
13511,
13540,
13086,
12591,
12931,
12848,
12859,
13271,
13600,
12576,
13602,
13080,
13455,
12875,
12920,
12588,
13541,
13582,
12866,
13095,
13304,
13478,
12675,
13349,
12609,
12577,
12665,
12667,
12812,
12871,
12663,
13506,
12901,
13595,
12935,
12768,
12753,
12587,
12776,
12778,
12817,
12754,
12756,
12549,
13378,
12569,
12739,
12949,
13529,
13288,
12781,
12786,
12741,
12790,
13147,
12814,
12823,
12832,
12837,
12839,
13021,
12840,
12657,
12855,
12856,
12863,
12872,
12743,
13100,
13116,
12886,
12889,
12895,
13228,
12744,
12905,
12746,
12911,
12912,
13052,
13431,
12921,
13276,
12749,
12747,
13230,
13231,
13222,
13221,
13220,
13219,
13218,
13217,
13216,
14635,
13215,
13214,
13213,
13212,
13211,
13210,
13209,
13208,
13207,
13206,
13205,
13204,
13203,
12565,
12765,
12662,
12770,
13536,
13248,
12720,
13538,
12660,
12861,
13262,
12624,
12773,
12694,
12831,
13253,
13563,
12554,
12874,
13359,
12797,
13466,
13473,
13472,
13033,
13952,
13462,
13549,
13279,
13280,
13278,
12585,
13057,
13429,
13277,
13141,
12622,
12975,
13402,
13224,
13457,
13435,
14310,
13437,
13434,
13564,
13090,
13094,
13552,
12919,
12592,
12710,
13281,
12571,
12870,
13077,
13105,
13409,
12761,
13274,
13191,
12795,
12996,
12822,
12894,
13411,
12683,
13534,
13404,
13024,
13480,
13132,
13133,
13394,
13153,
12985,
13005,
12594,
13467,
13525,
13527,
12878,
13528,
13416,
12805,
13103,
12623,
12586,
12775,
12799,
12716,
12717,
13442,
12913,
12718,
13143,
13383,
12794,
13382,
13085,
13441,
13562,
13393,
13283,
12564,
13182,
12783,
12809,
13430,
12853,
13201,
13083,
12559,
13542,
12581,
13286,
13285,
12573,
12757,
12593,
13603,
13302,
12833,
12599,
13040,
12940,
12659,
13287,
13372,
13373,
12638,
13168,
13374,
13579,
12557,
12620,
12645,
13369,
13197,
13371,
13370,
12641,
13193,
13194,
12639,
12644,
13177,
13178,
13365,
13179,
13229,
13186,
13361,
12642,
12643,
13362,
13364,
13363,
13169,
12646,
13187,
13172,
12561,
12648,
13092,
13123,
12640,
13161,
13162,
13160,
12631,
12612,
13159,
13165,
13166,
12637,
13163,
13164,
12610,
13167,
13612,
12619,
13156,
12602,
13157,
12603,
13607,
13609,
13608,
13585,
13175,
12613,
12614,
13557,
12617,
12618,
12649,
12650,
13173,
12634,
12636,
13199,
13200,
13342,
12615,
12621,
12629,
13158,
13195,
13170,
13267) and  changelistid = 25;